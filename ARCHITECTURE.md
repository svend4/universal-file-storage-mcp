# 🏗️ Архитектура Universal File Storage MCP

## 📐 Общая схема системы

```
┌────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                            │
│  Спрашивает: "Найди все файлы с бюджетом за 2024"             │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            ↓
┌────────────────────────────────────────────────────────────────┐
│                         CLAUDE AI                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Анализирует запрос:                                     │  │
│  │  • Нужен поиск по содержимому                            │  │
│  │  • Фильтр по ключевому слову: "бюджет"                  │  │
│  │  • Фильтр по году: "2024"                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬────────────────────────────────────┘
                            │ MCP Protocol
                            │ (HTTP/Server-Sent Events)
                            ↓
┌────────────────────────────────────────────────────────────────┐
│            UNIVERSAL FILE STORAGE MCP SERVER                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  🔧 TOOLS (MCP Endpoints):                              │  │
│  │  ┌──────────────┬──────────────┬──────────────────────┐ │  │
│  │  │ list_storages│ search_files │    read_file         │ │  │
│  │  └──────────────┴──────────────┴──────────────────────┘ │  │
│  │  ┌──────────────┐                                        │  │
│  │  │  list_files  │                                        │  │
│  │  └──────────────┘                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  📦 STORAGE ADAPTERS (Унифицированный доступ):          │  │
│  │  ┌──────────┬──────────┬──────────┬──────────────────┐  │  │
│  │  │  Local   │   NAS    │  Cloud   │    Android       │  │  │
│  │  │ Adapter  │ Adapter  │ Adapter  │    Adapter       │  │  │
│  │  └──────────┴──────────┴──────────┴──────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ⚙️ FEATURES:                                            │  │
│  │  • Полнотекстовый поиск (grep-like)                     │  │
│  │  • OCR Engine (Tesseract.js для изображений)            │  │
│  │  • Кэширование результатов                              │  │
│  │  • Индексация метаданных                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ↓                   ↓                   ↓
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   Windows    │   │     NAS      │   │    Cloud     │
│   Локально   │   │  Сетевое     │   │   Облако     │
│              │   │  хранилище   │   │              │
│ C:\Documents │   │//192.168.1.5 │   │WebDAV/S3/etc │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        ↓                   ↓                   ↓
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│    Linux     │   │   Android    │   │    macOS     │
│ /home/docs/  │   │ /storage/0/  │   │~/Documents/  │
└──────────────┘   └──────────────┘   └──────────────┘
```

---

## 🔄 Поток данных при поиске

```
1️⃣ Пользователь → Claude:
   "Найди все PDF с 'contract' на NAS"

2️⃣ Claude → MCP Server (search_files):
   {
     query: "contract",
     storage_ids: ["nas-storage"],
     file_types: [".pdf"],
     max_results: 20
   }

3️⃣ MCP Server → NAS Adapter:
   - Монтирует NAS (если нужно)
   - Получает список файлов
   - Фильтрует по типу (.pdf)

4️⃣ Для каждого PDF:
   - Читает содержимое
   - Ищет ключевое слово "contract"
   - Сохраняет совпадающие строки

5️⃣ MCP Server → Claude:
   {
     results: [
       {
         file: "agreement_2024.pdf",
         path: "/legal/agreement_2024.pdf",
         matches: [
           "The contract is valid until...",
           "Contractor obligations..."
         ],
         score: 15
       }
     ]
   }

6️⃣ Claude → Пользователь:
   "Найдено 5 файлов:
   
   📄 agreement_2024.pdf (15 совпадений)
   📄 vendor_contract.pdf (8 совпадений)
   ..."
```

---

## 🔌 Модульная архитектура Storage Adapters

```
┌─────────────────────────────────────────────────────┐
│           StorageAdapter (Abstract Base)            │
│  ┌───────────────────────────────────────────────┐  │
│  │  Interface:                                   │  │
│  │  • listFiles(path)                            │  │
│  │  • readFile(path)                             │  │
│  │  • searchFiles(query, options)                │  │
│  │  • extractTextFromImage(path)                 │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ↓               ↓               ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│LocalAdapter  │  │ NasAdapter   │  │CloudAdapter  │
├──────────────┤  ├──────────────┤  ├──────────────┤
│• fs.readdir  │  │• mount SMB   │  │• WebDAV      │
│• fs.readFile │  │• CIFS utils  │  │• HTTP client │
│• native I/O  │  │• NFS support │  │• S3 SDK      │
└──────────────┘  └──────────────┘  └──────────────┘
          │
          ↓
┌──────────────────┐
│ AndroidAdapter   │
├──────────────────┤
│• ADB shell       │
│• HTTP API        │
│• Termux support  │
└──────────────────┘
```

---

## 🎯 Как работает поиск (детально)

```
┌─────────────────────────────────────────────────┐
│  search_files("project alpha", {                │
│    storage_ids: ["windows", "nas"],             │
│    file_types: [".txt", ".md", ".docx"]         │
│  })                                             │
└──────────────────┬──────────────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  1. Выбор адаптеров                   │
   │     • Windows Adapter                 │
   │     • NAS Adapter                     │
   └───────────────┬───────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  2. Сканирование файлов               │
   │     Windows: 234 файла                │
   │     NAS: 1,456 файлов                 │
   └───────────────┬───────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  3. Фильтрация по типу                │
   │     Оставлено:                        │
   │     • 45 .txt файлов                  │
   │     • 23 .md файлов                   │
   │     • 12 .docx файлов                 │
   └───────────────┬───────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  4. Чтение и поиск                    │
   │     Для каждого файла:                │
   │     • Прочитать содержимое            │
   │     • Если изображение → OCR          │
   │     • Искать "project alpha"          │
   │     • Сохранить совпадающие строки    │
   └───────────────┬───────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  5. Ранжирование результатов          │
   │     По количеству совпадений:         │
   │     • readme.md (25 совпадений)       │
   │     • notes.txt (12 совпадений)       │
   │     • spec.docx (8 совпадений)        │
   └───────────────┬───────────────────────┘
                   │
                   ↓
   ┌───────────────────────────────────────┐
   │  6. Возврат результатов               │
   │     JSON + Markdown форматы           │
   └───────────────────────────────────────┘
```

---

## 🔐 Безопасность: Слои защиты

```
┌─────────────────────────────────────────────────┐
│  Уровень 1: Сетевой                             │
│  • Firewall rules (только localhost)           │
│  • VPN для удаленного доступа                   │
│  • HTTPS через reverse proxy (Nginx)           │
└──────────────────┬──────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────┐
│  Уровень 2: Аутентификация                      │
│  • API tokens (опционально)                     │
│  • Rate limiting                                │
│  • Request validation (Zod schemas)             │
└──────────────────┬──────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────┐
│  Уровень 3: Авторизация                         │
│  • Доступ только к настроенным хранилищам       │
│  • Read-only mode для критичных данных          │
│  • Path traversal protection                    │
└──────────────────┬──────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────┐
│  Уровень 4: Данные                              │
│  • Пароли в .env (не в коде!)                   │
│  • Шифрование на диске (BitLocker/LUKS)         │
│  • Безопасное удаление логов                    │
└─────────────────────────────────────────────────┘
```

---

## 📊 Производительность и масштабирование

### Текущая реализация (v1.0)

```
Прямое сканирование:
┌─────────┐    ┌─────────┐    ┌─────────┐
│  File1  │───►│  File2  │───►│  File3  │───► ...
└─────────┘    └─────────┘    └─────────┘

⚡ Скорость: ~100 файлов/сек (зависит от диска)
💾 Память: O(n) где n = количество совпадений
⏱️ Задержка: Пропорциональна размеру файловой системы
```

### Будущие оптимизации (v2.0+)

```
Индексированный поиск:
┌──────────────────┐
│  Search Index    │
│  (SQLite FTS5)   │
└────────┬─────────┘
         │
    ┌────┴────┐
    │  Query  │
    └────┬────┘
         │
    ┌────▼────────────────────────┐
    │ Results (мгновенно!)        │
    └─────────────────────────────┘

⚡ Скорость: ~10,000+ файлов/сек
💾 Память: O(1) + индекс (~10% от размера файлов)
⏱️ Задержка: Константная (миллисекунды)
```

---

## 🌍 Мультиплатформенная поддержка

```
┌────────────────────────────────────────────────┐
│           Node.js Runtime (v18+)               │
└──────────┬─────────────────────────────────────┘
           │
    ┌──────┴──────┐
    │  Abstraction │
    │    Layer     │
    └──────┬───────┘
           │
   ┌───────┴────────┐
   │                │
   ↓                ↓
┌─────────┐    ┌─────────┐
│ Windows │    │  Linux  │
│  APIs   │    │   APIs  │
│         │    │         │
│ • UNC   │    │ • CIFS  │
│ • SMB   │    │ • NFS   │
│ • NTFS  │    │ • ext4  │
└─────────┘    └─────────┘
   │                │
   ↓                ↓
┌─────────┐    ┌─────────┐
│  macOS  │    │ Android │
│  APIs   │    │   APIs  │
│         │    │         │
│ • SMB   │    │ • ADB   │
│ • HFS+  │    │ • HTTP  │
│ • APFS  │    │ • Termux│
└─────────┘    └─────────┘
```

---

## 🎨 Extensibility (Расширяемость)

### Добавление нового Storage Provider

```typescript
// 1. Создать новый адаптер
class DropboxAdapter extends StorageAdapter {
  async listFiles(path: string): Promise<FileEntry[]> {
    // Реализация через Dropbox API
  }
  
  async readFile(path: string): Promise<string> {
    // Реализация через Dropbox API
  }
}

// 2. Добавить в конфигурацию
const STORAGES = [
  ...existing,
  {
    id: "dropbox-main",
    type: "cloud",
    platform: "linux",
    path: "/",
    credentials: {
      url: "https://api.dropboxapi.com",
      token: process.env.DROPBOX_TOKEN
    },
    enabled: true
  }
];

// 3. Зарегистрировать адаптер
storageAdapters.push(new DropboxAdapter(config));
```

### Добавление нового инструмента (Tool)

```typescript
server.registerTool(
  "backup_file",
  {
    title: "Backup File",
    description: "Create backup copy of a file",
    inputSchema: z.object({
      source_storage: z.string(),
      source_path: z.string(),
      destination_storage: z.string()
    }),
    annotations: {
      readOnlyHint: false,
      destructiveHint: false
    }
  },
  async (params) => {
    // Реализация
  }
);
```

---

## 🚀 Roadmap (Планы развития)

### v1.0 ✅ (Текущая)
- ✅ Базовые storage adapters
- ✅ Поиск по содержимому
- ✅ OCR для изображений
- ✅ Мультиплатформенность

### v1.5 (Q2 2025)
- 🔄 Индексация для быстрого поиска
- 🔄 Кэширование результатов
- 🔄 Batch операции

### v2.0 (Q3 2025)
- 📋 Поддержка S3
- 📋 Google Drive integration
- 📋 Dropbox support
- 📋 OneDrive integration

### v2.5 (Q4 2025)
- 📋 Real-time file monitoring
- 📋 Automatic backup
- 📋 Version control
- 📋 Deduplication

### v3.0 (Q1 2026)
- 📋 AI-powered categorization
- 📋 Smart suggestions
- 📋 Collaboration features
- 📋 Web UI dashboard

---

## 💡 Ключевые преимущества архитектуры

### 1. Модульность
```
Каждый компонент независим
→ Легко добавлять новые адаптеры
→ Легко заменять реализации
→ Легко тестировать
```

### 2. Расширяемость
```
Унифицированный интерфейс
→ Любое хранилище как плагин
→ Любой инструмент как плагин
→ Любая функция как плагин
```

### 3. Производительность
```
Асинхронная обработка
→ Параллельное сканирование
→ Неблокирующий I/O
→ Stream обработка больших файлов
```

### 4. Надёжность
```
Graceful degradation
→ Если один storage недоступен - работают другие
→ Если OCR не работает - fallback к метаданным
→ Если нет интернета - работают локальные
```

---

## 🎓 Технический стек

```
┌──────────────────────────────────────────┐
│  Frontend (Claude AI)                    │
│  • Natural Language Processing           │
│  • Intent Recognition                    │
│  • Response Formatting                   │
└──────────────────┬───────────────────────┘
                   │ MCP Protocol
                   │ (HTTP/SSE)
                   ↓
┌──────────────────────────────────────────┐
│  Backend (Node.js + TypeScript)          │
│  ├─ Express.js (HTTP server)             │
│  ├─ @modelcontextprotocol/sdk            │
│  ├─ Zod (validation)                     │
│  └─ Tesseract.js (OCR)                   │
└──────────────────┬───────────────────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ↓                     ↓
┌──────────────┐      ┌──────────────┐
│ File System  │      │   Network    │
│   APIs       │      │   Protocols  │
├──────────────┤      ├──────────────┤
│• fs (Node.js)│      │• SMB/CIFS    │
│• path        │      │• WebDAV      │
│• child_process│      │• HTTP/HTTPS  │
└──────────────┘      │• ADB         │
                      └──────────────┘
```

---

**Created with ❤️ for maximum flexibility and performance**
